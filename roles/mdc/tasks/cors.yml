---
- name: Get secure route
  shell: "oc get route/mdc-mdc-proxy -o jsonpath='{.spec.host}' -n {{ mobile_services_namespace }}"
  register: mdc_route_cmd

- name: Read master config
  slurp:
    src: "{{ mdc_openshift_master_config_path }}"
  register: masterconf
  become: yes

- name: Add mdc route to corsAllowedOrigins in master config, matching indentation of existing items
  blockinfile:
    marker: "# {mark} GENERATED BY MDC INSTALLER"
    path: "{{ mdc_openshift_master_config_path }}"
    insertafter: "corsAllowedOrigins"
    backup: yes
    block: >
      {{ masterconf['content'] | b64decode
      | regex_replace('(?m)^[ \t]*#.+\n', '') 
      | regex_search('(?<=corsAllowedOrigins:\n)([ \t]*)') 
      }}- https://{{ mdc_route_cmd.stdout }}
  register: mdc_master_config_update
  become: yes
